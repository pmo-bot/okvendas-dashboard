<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMO | OkVendas</title>

<!-- Fontes e libs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --blue:#0ea5e9;
  --green:#10b981;
  --yellow:#f59e0b;
  --red:#ef4444;
  --purple:#8b5cf6;
  --text:#334155;
  --muted:#94a3b8;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,.05);
  
  --color-abraao: #FFB800;
  --color-dalto: #f97316;
  --color-jonathas: #38bdf8;
  --color-lucas: #0369a1;
  --color-efraim: #0d9488;
  --color-cristhian: #475569;
  --color-ernane: #1e3a8a;
  --color-william: #16a34a;
  
  --status-andamento-bg: #dcfce7;
  --status-andamento-text: #166534;
  --status-paralisado-bg: #fee2e2;
  --status-paralisado-text: #991b1b;
  --status-cliente-bg: #f3e8ff;
  --status-cliente-text: #7e22ce;
  --status-planejado-bg: #e5e7eb;
  --status-planejado-text: #475569;
  --status-concluido-bg: #dbeafe;
  --status-concluido-text: #1e40af;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background: linear-gradient(135deg, #f1f5f9 0%, #e0f2fe 50%, #f1f5f9 100%);
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
  font-family:'Inter',sans-serif;
  color:var(--text);
  padding:24px;
  overflow-x: hidden;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.container{max-width:1400px;margin:auto}

/* Banner de Erro de Conex√£o */
.connection-error {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  border: 2px solid #ef4444;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  display: none;
  align-items: center;
  gap: 15px;
  box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
}

.connection-error.show {
  display: flex;
}

.connection-error i {
  font-size: 24px;
  color: #dc2626;
}

.connection-error-content h3 {
  color: #991b1b;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 6px;
}

.connection-error-content p {
  color: #7f1d1d;
  font-size: 13px;
  line-height: 1.5;
}

.connection-error-content code {
  background: #991b1b;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-family: monospace;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
  flex-wrap: wrap;
  gap: 15px;
}

header h1{
  font-size:28px;
  font-weight:900;
  background: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
  text-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
}

header span{
  font-weight:300;
  color:var(--muted);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-refresh, .btn-clear-filters {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: var(--shadow);
}

.btn-refresh:hover {
  background: linear-gradient(135deg, #0ea5e9, #3b82f6);
  color: white;
  border-color: transparent;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
}

.btn-clear-filters {
  background: var(--red);
  color: white;
  border-color: var(--red);
  display: none;
}

.btn-clear-filters:hover {
  filter: brightness(1.1);
  transform: translateY(-2px);
}

.spinning {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.active-filters {
  background: var(--panel);
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  display: none;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  border-left: 4px solid var(--blue);
}

.active-filters .filter-label {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
}

.active-filters .filter-tag {
  background: var(--blue);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
  margin-bottom:30px;
}

.kpi{
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  padding:24px;
  border-radius:18px;
  box-shadow:var(--shadow);
  text-align:center;
  transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
  border: 2px solid transparent;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.kpi::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--blue), var(--purple), var(--blue));
  background-size: 200% 100%;
  opacity: 0;
  transition: opacity 0.3s;
}

.kpi:hover::before {
  opacity: 1;
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.kpi:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 40px rgba(14, 165, 233, 0.15);
  background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
}

.kpi.active {
  border-color: var(--blue);
  background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
  box-shadow: 0 8px 24px rgba(14, 165, 233, 0.2);
}

.kpi.active::before {
  opacity: 1;
}

.kpi:nth-child(1) { --kpi-color: var(--blue); }
.kpi:nth-child(2) { --kpi-color: var(--green); }
.kpi:nth-child(3) { --kpi-color: var(--yellow); }
.kpi:nth-child(4) { --kpi-color: var(--purple); }

.kpi i{
  font-size:28px;
  margin-bottom:12px;
  background: linear-gradient(135deg, var(--blue), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 2px 4px rgba(14, 165, 233, 0.2));
  transition: all 0.3s;
}

.kpi:nth-child(1) i {
  background: linear-gradient(135deg, #0ea5e9, #3b82f6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:nth-child(2) i {
  background: linear-gradient(135deg, #10b981, #059669);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:nth-child(3) i {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:nth-child(4) i {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:hover i {
  transform: scale(1.15) rotate(5deg);
  filter: drop-shadow(0 4px 8px rgba(14, 165, 233, 0.3));
}

.kpi h3{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}

.kpi p{
  font-size:36px;
  font-weight:900;
  background: linear-gradient(135deg, var(--blue), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -1px;
  transition: all 0.3s;
}

.kpi:nth-child(1) p {
  background: linear-gradient(135deg, #0ea5e9, #3b82f6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:nth-child(2) p {
  background: linear-gradient(135deg, #10b981, #059669);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:nth-child(3) p {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:nth-child(4) p {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi:hover p {
  transform: scale(1.05);
}

.kpi-hint {
  font-size: 10px;
  color: var(--muted);
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.2s;
}

.kpi:hover .kpi-hint {
  opacity: 1;
}

.charts{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.chart-box{
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius:18px;
  padding:24px;
  box-shadow:var(--shadow);
  height:380px;
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(14, 165, 233, 0.1);
  transition: all 0.3s;
}

.chart-box:hover {
  box-shadow: 0 12px 32px rgba(14, 165, 233, 0.12);
  transform: translateY(-3px);
  border-color: rgba(14, 165, 233, 0.2);
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  gap: 12px;
}

.chart-title{
  font-size:14px;
  font-weight:700;
  background: linear-gradient(135deg, var(--text), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
}

.info-icon {
  cursor: help;
  color: var(--blue);
  font-size: 14px;
  position: relative;
  display: inline-flex;
  align-items: center;
  transition: color 0.2s;
}

.info-icon:hover {
  color: var(--purple);
}

.tooltip {
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: white;
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 500;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  z-index: 1000;
  line-height: 1.5;
}

.info-icon:hover .tooltip {
  opacity: 1;
}

.curva-info {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-left: 4px solid var(--blue);
  padding: 12px 16px;
  border-radius: 8px;
  margin-top: 12px;
  font-size: 12px;
  color: var(--text);
  display: none;
  align-items: center;
  gap: 10px;
  box-shadow: 0 2px 8px rgba(14, 165, 233, 0.1);
}

.curva-info.show {
  display: flex;
}

.semaforo-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}

.semaforo-verde { background: #10b981; }
.semaforo-amarelo { background: #f59e0b; }
.semaforo-vermelho { background: #ef4444; }

.chart-filter {
  display: flex;
  align-items: center;
  gap: 8px;
}

.chart-filter label {
  font-size: 11px;
  color: var(--muted);
  font-weight: 600;
}

.chart-filter select {
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
  background: var(--panel);
  cursor: pointer;
  transition: all 0.2s;
}

.chart-filter select:hover {
  border-color: var(--blue);
}

.chart-filter select:focus {
  outline: none;
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.chart-canvas {
  flex: 1;
  min-height: 0;
  position: relative;
}

.project-table {
  background: var(--panel);
  border-radius: 18px;
  padding: 24px;
  box-shadow: var(--shadow);
  overflow: hidden;
}

.project-table h2 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

.project-table h2 i {
  color: var(--blue);
}

.table-wrapper {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid var(--border);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

thead {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  position: sticky;
  top: 0;
  z-index: 10;
}

thead th {
  padding: 14px 16px;
  text-align: left;
  font-weight: 700;
  color: var(--text);
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.2s;
}

tbody tr:hover {
  background: linear-gradient(90deg, #f0f9ff 0%, #f8fafc 100%);
  transform: scale(1.005);
  box-shadow: 0 2px 8px rgba(14, 165, 233, 0.08);
}

tbody td {
  padding: 14px 16px;
  color: var(--text);
}

.project-name {
  font-weight: 700;
  color: var(--blue);
  cursor: pointer;
  transition: color 0.2s;
}

.project-name:hover {
  background: linear-gradient(135deg, var(--purple), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-decoration: underline;
  transform: translateX(3px);
}

.analista-bold {
  font-weight: 700;
}

.data-prevista-customizada {
  padding: 4px 10px !important;
  border-radius: 6px;
  font-weight: 700;
  display: inline-block;
}

.abraao { color: var(--color-abraao); }
.dalto { color: var(--color-dalto); }
.jonathas { color: var(--color-jonathas); }
.lucas { color: var(--color-lucas); }
.efraim { color: var(--color-efraim); }
.cristhian { color: var(--color-cristhian); }
.ernane { color: var(--color-ernane); }
.william { color: var(--color-william); }

.badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-block;
}

.emandamento { background: var(--status-andamento-bg); color: var(--status-andamento-text); }
.paralisado { background: var(--status-paralisado-bg); color: var(--status-paralisado-text); }
.aguardandocliente { background: var(--status-cliente-bg); color: var(--status-cliente-text); }
.planejado { background: var(--status-planejado-bg); color: var(--status-planejado-text); }
.concluido { background: var(--status-concluido-bg); color: var(--status-concluido-text); }

.progress {
  display: flex;
  align-items: center;
  gap: 12px;
}

.bar {
  flex: 1;
  height: 10px;
  background: #e5e7eb;
  border-radius: 20px;
  overflow: hidden;
  position: relative;
}

.fill {
  height: 100%;
  background: linear-gradient(90deg, #0ea5e9 0%, #8b5cf6 50%, #10b981 100%);
  background-size: 200% 100%;
  border-radius: 20px;
  transition: width 0.6s ease;
  animation: progressShine 3s ease-in-out infinite;
  box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
}

@keyframes progressShine {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

.no-results {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.no-results i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.no-results h3 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--panel);
  padding: 32px;
  border-radius: 20px;
  width: 90%;
  max-width: 600px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s;
  position: relative;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
}

.modal-header h2 {
  font-size: 20px;
  font-weight: 800;
  color: var(--blue);
}

.close {
  color: var(--muted);
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.close:hover {
  color: var(--red);
  background: #fee2e2;
  transform: rotate(90deg);
}

.modal-row {
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 12px;
  margin-bottom: 16px;
  align-items: start;
}

.modal-row strong {
  color: var(--muted);
  font-size: 12px;
  text-transform: uppercase;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.modal-row span {
  color: var(--text);
  font-size: 14px;
  font-weight: 600;
  line-height: 1.6;
}

.modal-section {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.modal-section h3 {
  font-size: 14px;
  font-weight: 700;
  color: var(--blue);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

@media (max-width: 768px) {
  body { padding: 16px; }
  .charts { grid-template-columns: 1fr; }
  .chart-box { height: 320px; }
  .modal-content { padding: 24px; width: 95%; }
  .modal-row { grid-template-columns: 1fr; gap: 6px; }
  header { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>
<div class="container">

  <!-- Banner de Erro de Conex√£o -->
  <div class="connection-error" id="connectionError">
    <i class="fa-solid fa-triangle-exclamation"></i>
    <div class="connection-error-content">
      <h3>‚ö†Ô∏è Erro de Conex√£o com Google Sheets</h3>
      <p>
        N√£o foi poss√≠vel carregar os dados. Verifique sua conex√£o com a internet e tente novamente.
      </p>
    </div>
  </div>

  <header>
    <div>
      <h1>PMO Dashboard <span>| OkVendas</span></h1>
    </div>
    <div class="header-actions">
      <button class="btn-refresh" onclick="fetchData()">
        <i class="fa-solid fa-arrows-rotate" id="refreshIcon"></i>
        Atualizar
      </button>
      <button class="btn-clear-filters" id="btnClearFilters" onclick="clearAllFilters()">
        <i class="fa-solid fa-filter-circle-xmark"></i>
        Limpar Filtros
      </button>
    </div>
  </header>

  <div class="active-filters" id="activeFilters">
    <span class="filter-label">Filtros Ativos:</span>
    <div id="filterTags"></div>
  </div>

  <div class="kpis">
    <div class="kpi" onclick="filterByStatus(null)">
      <i class="fa-solid fa-diagram-project"></i>
      <h3>Total Projetos</h3>
      <p id="kTotal">0</p>
      <div class="kpi-hint">Clique para ver todos</div>
    </div>
    <div class="kpi" onclick="filterByStatus('andamento')">
      <i class="fa-solid fa-play"></i>
      <h3>Em Andamento</h3>
      <p id="kAtivos">0</p>
      <div class="kpi-hint">Clique para filtrar</div>
    </div>
    <div class="kpi" onclick="filterByStatus('paralisado')">
      <i class="fa-solid fa-pause"></i>
      <h3>Paralisados</h3>
      <p id="kPausados">0</p>
      <div class="kpi-hint">Clique para filtrar</div>
    </div>
    <div class="kpi" onclick="filterByStatus('cliente')">
      <i class="fa-solid fa-clock"></i>
      <h3>Aguardando Cliente</h3>
      <p id="kCliente">0</p>
      <div class="kpi-hint">Clique para filtrar</div>
    </div>
  </div>

  <div class="charts">
    <div class="chart-box">
      <div class="chart-header">
        <span class="chart-title">
          <i class="fa-solid fa-chart-pie"></i>
          Distribui√ß√£o por Status
        </span>
      </div>
      <div class="chart-canvas">
        <canvas id="status"></canvas>
      </div>
    </div>

    <div class="chart-box">
      <div class="chart-header">
        <span class="chart-title">
          <i class="fa-solid fa-users"></i>
          Carga por Analista
        </span>
        <div class="chart-filter">
          <label for="analistaSelect">Filtro:</label>
          <select id="analistaSelect" onchange="updateAnalistaChart()">
            <option value="all">Todos</option>
          </select>
        </div>
      </div>
      <div class="chart-canvas">
        <canvas id="analistas"></canvas>
      </div>
    </div>

    <div class="chart-box">
      <div class="chart-header">
        <span class="chart-title">
          <i class="fa-solid fa-chart-line"></i>
          Curva S de Progresso
          <span class="info-icon">
            <i class="fa-solid fa-circle-info"></i>
            <span class="tooltip">Compara o progresso planejado (100%) com o realizado. Verde: no prazo | Amarelo: aten√ß√£o | Vermelho: atrasado</span>
          </span>
        </span>
        <div class="chart-filter">
          <label for="projectSelect">Projeto:</label>
          <select id="projectSelect" onchange="updateCurvaS()">
            <option value="all">Vis√£o Geral</option>
          </select>
        </div>
      </div>
      <div class="chart-canvas">
        <canvas id="curve"></canvas>
      </div>
      <div class="curva-info" id="curvaInfo"></div>
    </div>
  </div>

  <div class="project-table">
    <h2><i class="fa-solid fa-table"></i> Detalhamento de Projetos</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Projeto</th>
            <th>Data Prevista</th>
            <th>Analista</th>
            <th>Status</th>
            <th>Evolu√ß√£o</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">Carregando dados...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="mTitle"></h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-row">
      <strong>Analista:</strong>
      <span id="mAnalista"></span>
    </div>
    <div class="modal-row">
      <strong>Status:</strong>
      <span id="mStatus"></span>
    </div>
    <div class="modal-row">
      <strong>Data Prevista:</strong>
      <span id="mData"></span>
    </div>
    <div class="modal-section">
      <h3>Atividades</h3>
      <div class="modal-row">
        <strong>Conclu√≠das:</strong>
        <span id="mConcluidas"></span>
      </div>
      <div class="modal-row">
        <strong>Valida√ß√£o:</strong>
        <span id="mValidacao"></span>
      </div>
      <div class="modal-row">
        <strong>Libera√ß√£o:</strong>
        <span id="mLiberacao"></span>
      </div>
      <div class="modal-row">
        <strong>Execu√ß√£o:</strong>
        <span id="mExecucao"></span>
      </div>
      <div class="modal-row">
        <strong>In√≠cio:</strong>
        <span id="mInicio"></span>
      </div>
      <div class="modal-row">
        <strong>Total:</strong>
        <span id="mTotal"></span>
      </div>
    </div>
    <div class="modal-section">
      <h3>Descri√ß√£o</h3>
      <div class="modal-row">
        <span id="mDescricao" style="grid-column: 1 / -1;"></span>
      </div>
    </div>
    <div class="modal-section">
      <h3>Observa√ß√µes</h3>
      <div class="modal-row">
        <span id="mObs" style="grid-column: 1 / -1;"></span>
      </div>
    </div>
  </div>
</div>

<script>
// ========== CONFIGURA√á√ÉO ==========
// URL da planilha publicada (formato CSV via Google Visualization API)
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSN6220bHIwZ9pzMZkhQ1hBT32sofXNn-FSvJYDNGFVKNCtEhpTqF3yg4zz-p25nALcm1J33QeLR_pn/pub?gid=378165818&single=true&output=csv';

const DEBUG_MODE = true; // Ative para ver logs no console

// ========== ESTADO GLOBAL ==========
let projectData = [];
let charts = { status: null, analistas: null, curve: null };
let currentFilters = { analista: null, status: null };

// ========== FUN√á√ïES DE DEBUG ==========
function debugLog(message, type = 'info') {
  if (!DEBUG_MODE) return;
  const styles = {
    info: 'color: #0ea5e9; font-weight: bold',
    success: 'color: #10b981; font-weight: bold',
    warning: 'color: #f59e0b; font-weight: bold',
    error: 'color: #ef4444; font-weight: bold'
  };
  console.log(`%c[PMO] ${message}`, styles[type] || styles.info);
}

// ========== FETCH DE DADOS ==========
async function fetchData() {
  const refreshIcon = document.getElementById('refreshIcon');
  const errorBanner = document.getElementById('connectionError');
  
  refreshIcon?.classList.add('spinning');
  errorBanner.classList.remove('show');
  
  debugLog('üîÑ Iniciando fetch dos dados...', 'info');
  
  try {
    const response = await fetch(SHEET_URL);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const csvText = await response.text();
    debugLog('üì• Resposta CSV recebida, processando...', 'info');
    
    // Parse CSV
    const lines = csvText.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    
    projectData = lines.slice(1).map(line => {
      // Parse CSV respeitando aspas
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let char of line) {
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim().replace(/^"|"$/g, ''));
          current = '';
        } else {
          current += char;
        }
      }
      values.push(current.trim().replace(/^"|"$/g, ''));
      
      return {
        Projeto: values[0] || '',
        DataPrevista: values[1] || '',
        Analista: values[2] || '',
        Status: values[3] || '',
        Concluidas: parseInt(values[4]) || 0,
        Validacao: parseInt(values[5]) || 0,
        Liberacao: parseInt(values[6]) || 0,
        Execucao: parseInt(values[7]) || 0,
        Inicio: parseInt(values[8]) || 0,
        Total: parseInt(values[9]) || 0,
        Descricao: values[10] || '',
        Obs: values[11] || '',
        CorDataPrevista: values[12] || ''
      };
    }).filter(p => p.Projeto);
    
    debugLog(`‚úÖ Dados processados: ${projectData.length} projetos encontrados`, 'success');
    
    populateSelects();
    renderAll();
    errorBanner.classList.remove('show');
    
  } catch (error) {
    debugLog(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
    errorBanner.classList.add('show');
    console.error('Detalhes do erro:', error);
  } finally {
    refreshIcon?.classList.remove('spinning');
  }
}

// ========== SELETORES ==========
function populateSelects() {
  const analistaSelect = document.getElementById('analistaSelect');
  const projectSelect = document.getElementById('projectSelect');
  
  const analistas = [...new Set(projectData.map(p => p.Analista))].sort();
  analistaSelect.innerHTML = '<option value="all">Todos</option>' + 
    analistas.map(a => `<option value="${a}">${a}</option>`).join('');
  
  const projetos = [...new Set(projectData.map(p => p.Projeto))].sort();
  projectSelect.innerHTML = '<option value="all">Vis√£o Geral</option>' + 
    projetos.map(p => `<option value="${p}">${p}</option>`).join('');
  
  debugLog(`üìã Seletores populados: ${analistas.length} analistas, ${projetos.length} projetos`, 'info');
}

// ========== HELPERS ==========
function cleanKey(str) {
  return (str || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '');
}

function getAnalistaClass(nome) {
  const map = {
    'abra√£o': 'abraao', 'dalto': 'dalto', 'jonathas': 'jonathas',
    'lucas': 'lucas', 'efraim': 'efraim', 'cristhian': 'cristhian',
    'ernane': 'ernane', 'william': 'william'
  };
  return map[cleanKey(nome)] || '';
}

function getAnalistaColor(nome) {
  const colors = {
    'abra√£o': '#FFB800', 'dalto': '#f97316', 'jonathas': '#38bdf8',
    'lucas': '#0369a1', 'efraim': '#0d9488', 'cristhian': '#475569',
    'ernane': '#1e3a8a', 'william': '#16a34a'
  };
  return colors[cleanKey(nome)] || '#64748b';
}

function getStatusColor(status) {
  const map = {
    'andamento': '#10b981', 'paralisado': '#ef4444',
    'cliente': '#8b5cf6', 'planejado': '#94a3b8', 'concluido': '#0ea5e9'
  };
  const key = cleanKey(status);
  for (let k in map) {
    if (key.includes(k)) return map[k];
  }
  return '#64748b';
}

function calcularEvolucaoPonderada(projeto) {
  const { Concluidas, Validacao, Liberacao, Execucao, Inicio, Total } = projeto;
  
  if (Total === 0) return 0;
  
  const pesoInicio = 0.05;
  const pesoExecucao = 0.20;
  const pesoLiberacao = 0.30;
  const pesoValidacao = 0.35;
  const pesoConcluidas = 1.00;
  
  const pontuacaoTotal = 
    (Inicio * pesoInicio) +
    (Execucao * pesoExecucao) +
    (Liberacao * pesoLiberacao) +
    (Validacao * pesoValidacao) +
    (Concluidas * pesoConcluidas);
  
  const pontuacaoMaxima = Total;
  const percentual = (pontuacaoTotal / pontuacaoMaxima) * 100;
  
  return Math.min(Math.round(percentual), 100);
}

function getSemaforoColor(diferenca) {
  if (diferenca <= 15) return 'verde';
  if (diferenca <= 35) return 'amarelo';
  return 'vermelho';
}

// ========== DESTROY CHARTS ==========
function destroyChart(chartName) {
  if (charts[chartName]) {
    charts[chartName].destroy();
    charts[chartName] = null;
    debugLog(`üóëÔ∏è Gr√°fico ${chartName} destru√≠do`, 'info');
  }
}

function destroyAllCharts() {
  Object.keys(charts).forEach(key => destroyChart(key));
  debugLog('üóëÔ∏è Todos os gr√°ficos destru√≠dos', 'info');
}

// ========== FILTROS ==========
function filterByStatus(status) {
  currentFilters.status = status;
  updateFilterDisplay();
  renderAll();
  updateActiveKPI();
  debugLog(`üîç Filtro de status aplicado: ${status || 'todos'}`, 'info');
}

function clearAllFilters() {
  currentFilters = { analista: null, status: null };
  document.getElementById('analistaSelect').value = 'all';
  updateFilterDisplay();
  renderAll();
  updateActiveKPI();
  debugLog('üßπ Filtros limpos', 'info');
}

function updateFilterDisplay() {
  const activeFiltersDiv = document.getElementById('activeFilters');
  const filterTagsDiv = document.getElementById('filterTags');
  const btnClear = document.getElementById('btnClearFilters');
  
  const hasFilters = currentFilters.analista || currentFilters.status;
  
  if (hasFilters) {
    let tags = '';
    if (currentFilters.analista) tags += `<span class="filter-tag"><i class="fa-solid fa-user"></i> ${currentFilters.analista}</span>`;
    if (currentFilters.status) tags += `<span class="filter-tag"><i class="fa-solid fa-circle-dot"></i> ${currentFilters.status}</span>`;
    
    filterTagsDiv.innerHTML = tags;
    activeFiltersDiv.style.display = 'flex';
    btnClear.style.display = 'flex';
  } else {
    activeFiltersDiv.style.display = 'none';
    btnClear.style.display = 'none';
  }
}

function updateActiveKPI() {
  const kpis = document.querySelectorAll('.kpi');
  kpis.forEach(k => k.classList.remove('active'));
  
  if (currentFilters.status === 'andamento') kpis[1]?.classList.add('active');
  else if (currentFilters.status === 'paralisado') kpis[2]?.classList.add('active');
  else if (currentFilters.status === 'cliente') kpis[3]?.classList.add('active');
  else if (!currentFilters.status) kpis[0]?.classList.add('active');
}

function getFilteredData() {
  let filtered = [...projectData];
  if (currentFilters.analista) filtered = filtered.filter(p => p.Analista === currentFilters.analista);
  if (currentFilters.status) filtered = filtered.filter(p => cleanKey(p.Status).includes(currentFilters.status));
  return filtered;
}

// ========== RENDER ==========
function renderAll() {
  const filtered = getFilteredData();
  renderTable(filtered);
  renderKPIs(projectData);
  renderCharts(filtered);
}

function renderTable(p) {
  const tb = document.getElementById("tbody");
  if (p.length === 0) {
    tb.innerHTML = `<tr><td colspan="6"><div class="no-results"><i class="fa-solid fa-inbox"></i><h3>Nenhum projeto encontrado</h3><p style="margin-top:8px;font-size:13px">Ajuste os filtros</p></div></td></tr>`;
    return;
  }
  
  tb.innerHTML = p.map(x => {
    const perc = calcularEvolucaoPonderada(x);
    const statusClass = cleanKey(x.Status).replace(/\./g, "").replace(/\s/g, '-');
    const analistaClass = getAnalistaClass(x.Analista);
    
    const projetoEscaped = x.Projeto.replace(/'/g, "\\'").replace(/`/g, "\\`");
    
    const dataStyle = x.CorDataPrevista 
      ? `style="background-color: ${x.CorDataPrevista}; color: white;" class="data-prevista-customizada"`
      : '';
    
    return `<tr>
      <td><span class="project-name" onclick="openProjectModal('${projetoEscaped}')">${x.Projeto}</span></td>
      <td><span ${dataStyle}>${x.DataPrevista}</span></td>
      <td class="analista-bold ${analistaClass}">${x.Analista}</td>
      <td><span class="badge ${statusClass}">${x.Status}</span></td>
      <td><div class="progress"><div class="bar"><div class="fill" style="width:${perc}%"></div></div><strong style="width:35px;text-align:right">${perc}%</strong></div></td>
      <td><i class="fa-solid fa-circle-info" style="cursor:pointer;color:var(--blue)" onclick="openProjectModal('${projetoEscaped}')"></i></td>
    </tr>`;
  }).join("");
}

function renderKPIs(p) {
  document.getElementById("kTotal").innerText = p.length;
  document.getElementById("kAtivos").innerText = p.filter(x => cleanKey(x.Status).includes("andamento")).length;
  document.getElementById("kPausados").innerText = p.filter(x => cleanKey(x.Status).includes("paralisado")).length;
  document.getElementById("kCliente").innerText = p.filter(x => cleanKey(x.Status).includes("cliente")).length;
}

function renderCharts(p) {
  if (p.length === 0) {
    destroyAllCharts();
    return;
  }
  
  renderStatusChart(p);
  updateAnalistaChart();
  updateCurvaS();
}

function renderStatusChart(p) {
  const statusCount = {};
  p.forEach(x => {
    statusCount[x.Status] = (statusCount[x.Status] || 0) + 1;
  });
  
  destroyChart('status');
  
  const statusLabels = Object.keys(statusCount);
  const statusColors = statusLabels.map(s => getStatusColor(s));
  
  const statusCanvas = document.getElementById('status');
  if (!statusCanvas) {
    debugLog('‚ö†Ô∏è Canvas de status n√£o encontrado', 'warning');
    return;
  }
  
  charts.status = new Chart(statusCanvas, {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{ data: Object.values(statusCount), backgroundColor: statusColors, borderWidth: 0, hoverOffset: 10 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11, weight: '600' } } },
        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed} projeto(s)` } }
      }
    }
  });
  
  debugLog(`‚úÖ Gr√°fico de status criado com ${statusLabels.length} categorias`, 'success');
}

function updateAnalistaChart() {
  const select = document.getElementById('analistaSelect');
  const selectedAnalista = select.value;
  
  if (selectedAnalista !== 'all' && currentFilters.analista !== selectedAnalista) {
    currentFilters.analista = selectedAnalista;
    renderAll();
    return;
  }
  
  if (selectedAnalista === 'all' && currentFilters.analista) {
    currentFilters.analista = null;
    renderAll();
    return;
  }
  
  let dataToShow = getFilteredData();
  
  const analistasCount = {};
  dataToShow.forEach(x => {
    analistasCount[x.Analista] = (analistasCount[x.Analista] || 0) + 1;
  });
  
  const analistaLabels = Object.keys(analistasCount).sort((a, b) => 
    analistasCount[b] - analistasCount[a]
  );
  const analistaColors = analistaLabels.map(n => getAnalistaColor(n));
  
  destroyChart('analistas');
  
  const analistasCanvas = document.getElementById('analistas');
  if (!analistasCanvas) {
    debugLog('‚ö†Ô∏è Canvas de analistas n√£o encontrado', 'warning');
    return;
  }
  
  charts.analistas = new Chart(analistasCanvas, {
    type: 'bar',
    data: {
      labels: analistaLabels,
      datasets: [{ data: analistaLabels.map(a => analistasCount[a]), backgroundColor: analistaColors, borderRadius: 6, barThickness: 20 }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.x} projeto(s)` } }
      },
      scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
  
  debugLog(`‚úÖ Gr√°fico de analistas criado com ${analistaLabels.length} analistas (ordenado por carga)`, 'success');
}

function updateCurvaS() {
  const select = document.getElementById('projectSelect');
  const selectedProject = select.value;
  const curvaInfoEl = document.getElementById('curvaInfo');
  
  let data, label, cor, diferenca;
  
  if (selectedProject === 'all') {
    const filtered = getFilteredData();
    const media = filtered.length > 0 
      ? Math.round(filtered.reduce((acc, curr) => acc + calcularEvolucaoPonderada(curr), 0) / filtered.length)
      : 0;
    
    diferenca = 100 - media;
    const semaforo = getSemaforoColor(diferenca);
    cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
    
    data = [0, media];
    label = 'Realizado (M√©dia Geral)';
    
    curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado`;
    curvaInfoEl.classList.add('show');
  } else {
    const projeto = projectData.find(p => p.Projeto === selectedProject);
    if (projeto) {
      const perc = calcularEvolucaoPonderada(projeto);
      diferenca = 100 - perc;
      const semaforo = getSemaforoColor(diferenca);
      cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
      
      data = [0, perc];
      label = `Realizado (${projeto.Projeto})`;
      
      curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado | <strong>${projeto.Concluidas}/${projeto.Total}</strong> atividades`;
      curvaInfoEl.classList.add('show');
    } else {
      debugLog('‚ö†Ô∏è Projeto n√£o encontrado para Curva S', 'warning');
      return;
    }
  }
  
  destroyChart('curve');
  
  const curveCanvas = document.getElementById('curve');
  if (!curveCanvas) {
    debugLog('‚ö†Ô∏è Canvas de curva S n√£o encontrado', 'warning');
    return;
  }
  
  charts.curve = new Chart(curveCanvas, {
    type: 'line',
    data: {
      labels: ['In√≠cio', 'Progresso Atual'],
      datasets: [
        { label: 'Meta Planejada', data: [0, 100], borderColor: '#94a3b8', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0.4, pointRadius: 4 },
        { label: label, data: data, borderColor: cor, backgroundColor: cor + '20', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 7 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11, weight: '600' } } },
        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}%` } }
      },
      scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (v) => v + '%' } } }
    }
  });
  
  debugLog(`‚úÖ Curva S criada para: ${selectedProject === 'all' ? 'Vis√£o Geral' : selectedProject}`, 'success');
}

// ========== MODAL ==========
function openProjectModal(projectName) {
  const projeto = projectData.find(p => p.Projeto === projectName);
  
  if (!projeto) return;
  
  document.getElementById("mTitle").textContent = projeto.Projeto;
  document.getElementById("mAnalista").textContent = projeto.Analista;
  document.getElementById("mStatus").textContent = projeto.Status;
  
  const dataEl = document.getElementById("mData");
  dataEl.textContent = projeto.DataPrevista;
  if (projeto.CorDataPrevista) {
    dataEl.style.backgroundColor = projeto.CorDataPrevista;
    dataEl.style.color = 'white';
    dataEl.style.padding = '6px 12px';
    dataEl.style.borderRadius = '8px';
    dataEl.style.display = 'inline-block';
    dataEl.style.fontWeight = '700';
  } else {
    dataEl.style.backgroundColor = '';
    dataEl.style.color = '';
    dataEl.style.padding = '';
    dataEl.style.borderRadius = '';
    dataEl.style.display = '';
    dataEl.style.fontWeight = '';
  }
  
  document.getElementById("mConcluidas").textContent = projeto.Concluidas;
  document.getElementById("mValidacao").textContent = projeto.Validacao;
  document.getElementById("mLiberacao").textContent = projeto.Liberacao;
  document.getElementById("mExecucao").textContent = projeto.Execucao;
  document.getElementById("mInicio").textContent = projeto.Inicio;
  document.getElementById("mDescricao").textContent = projeto.Descricao;
  document.getElementById("mTotal").textContent = projeto.Total;
  document.getElementById("mObs").textContent = projeto.Obs;
  
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

window.onclick = e => {
  if (e.target == document.getElementById("modal")) closeModal();
}

// ========== INIT ==========
window.onload = fetchData;
setInterval(fetchData, 300000); // Atualiza a cada 5 minutos
window.addEventListener('beforeunload', () => {
  destroyAllCharts();
  clearAllFilters();
});
</script>
</body>
</html>
