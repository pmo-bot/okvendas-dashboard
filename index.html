<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMO | OkVendas</title>

<!-- Fontes e libs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --blue:#0ea5e9;
  --green:#10b981;
  --yellow:#f59e0b;
  --red:#ef4444;
  --purple:#8b5cf6;
  --text:#334155;
  --muted:#94a3b8;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,.05);
  
  --color-abraao: #FFB800;
  --color-dalto: #f97316;
  --color-jonathas: #38bdf8;
  --color-lucas: #0369a1;
  --color-efraim: #0d9488;
  --color-cristhian: #475569;
  --color-ernane: #1e3a8a;
  --color-william: #16a34a;
  
  --status-andamento-bg: #dcfce7;
  --status-andamento-text: #166534;
  --status-paralisado-bg: #fee2e2;
  --status-paralisado-text: #991b1b;
  --status-cliente-bg: #f3e8ff;
  --status-cliente-text: #7e22ce;
  --status-planejado-bg: #e5e7eb;
  --status-planejado-text: #475569;
  --status-concluido-bg: #dbeafe;
  --status-concluido-text: #1e40af;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:var(--text);
  padding:24px;
  overflow-x: hidden;
}

.container{max-width:1400px;margin:auto}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
  flex-wrap: wrap;
  gap: 15px;
}

header h1{
  font-size:24px;
  font-weight:800;
  color:var(--blue);
}

header span{
  font-weight:300;
  color:var(--muted);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-refresh, .btn-clear-filters {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: var(--shadow);
}

.btn-refresh:hover {
  background: var(--blue);
  color: white;
  border-color: var(--blue);
}

.btn-clear-filters {
  background: var(--red);
  color: white;
  border-color: var(--red);
  display: none;
}

.btn-clear-filters:hover {
  filter: brightness(1.1);
  transform: translateY(-2px);
}

.spinning {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.active-filters {
  background: var(--panel);
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  display: none;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  border-left: 4px solid var(--blue);
}

.active-filters .filter-label {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
}

.active-filters .filter-tag {
  background: var(--blue);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
  margin-bottom:30px;
}

.kpi{
  background:var(--panel);
  padding:24px;
  border-radius:18px;
  box-shadow:var(--shadow);
  text-align:center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid transparent;
  cursor: pointer;
  position: relative;
}

.kpi:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  border-color: var(--blue);
}

.kpi.active {
  border-color: var(--blue);
  background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
}

.kpi i{
  font-size:18px;
  margin-bottom:10px;
  color: var(--blue);
}

.kpi h3{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}

.kpi p{
  font-size:32px;
  font-weight:800;
}

.kpi-hint {
  font-size: 10px;
  color: var(--muted);
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.2s;
}

.kpi:hover .kpi-hint {
  opacity: 1;
}

.charts{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.chart-box{
  background:var(--panel);
  border-radius:18px;
  padding:24px;
  box-shadow:var(--shadow);
  height:380px;
  display: flex;
  flex-direction: column;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  gap: 12px;
}

.chart-title{
  font-size:13px;
  font-weight:700;
  color: var(--text);
  white-space: nowrap;
}

.chart-select {
  padding: 8px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
  background: white;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  min-width: 150px;
}

.chart-select:hover {
  border-color: var(--blue);
}

.chart-select:focus {
  outline: none;
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.chart-info {
  font-size: 11px;
  color: var(--muted);
  margin-top: 8px;
  padding: 8px 12px;
  background: #f8fafc;
  border-radius: 8px;
  display: none;
}

.chart-info.show {
  display: block;
}

.semaforo-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 6px;
}

.semaforo-verde { background: var(--green); }
.semaforo-amarelo { background: var(--yellow); }
.semaforo-vermelho { background: var(--red); }

.chart-container {
  flex: 1;
  position: relative;
  min-height: 0;
  width: 100%;
}

.table-box{
  background:var(--panel);
  border-radius:18px;
  padding:24px;
  box-shadow:var(--shadow);
  overflow-x: auto;
}

.table-title{
  font-size:16px;
  font-weight:700;
  margin-bottom:20px;
  color:var(--text);
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width: 900px;
}

th{
  background:#fafafa;
  padding:16px 12px;
  font-size:11px;
  text-transform:uppercase;
  color:var(--muted);
  text-align:left;
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom:2px solid var(--border);
}

th:nth-child(1) { width: 20%; }
th:nth-child(2) { width: 12%; }
th:nth-child(3) { width: 12%; text-align: center; }
th:nth-child(4) { width: 12%; text-align: center; }
th:nth-child(5) { width: 20%; }
th:nth-child(6) { width: 8%; text-align: center; }

td{
  padding:14px 12px;
  border-bottom:1px solid #f1f5f9;
}

td:nth-child(3), td:nth-child(4), td:nth-child(6) {
  text-align: center;
}

tr:hover{background:#f8fafc}

.project-name {
  cursor: pointer;
  color: var(--blue);
  font-weight: 700;
  transition: all 0.2s;
}

.project-name:hover {
  text-decoration: underline;
  color: var(--text);
}

.badge{
  padding:6px 12px;
  border-radius:20px;
  font-size:11px;
  font-weight:700;
  display: inline-block;
  white-space: nowrap;
  text-transform: uppercase;
}

.badge.emandamento, .badge.em-andamento, .badge.andamento {
  background:var(--status-andamento-bg);
  color:var(--status-andamento-text);
}

.badge.paralisado{
  background:var(--status-paralisado-bg);
  color:var(--status-paralisado-text);
}

.badge.agcliente, .badge.ag-cliente, .badge.aguardandocliente {
  background:var(--status-cliente-bg);
  color:var(--status-cliente-text);
}

.badge.planejado{
  background:var(--status-planejado-bg);
  color:var(--status-planejado-text);
}

.badge.concluido{
  background:var(--status-concluido-bg);
  color:var(--status-concluido-text);
}

.analista-bold { font-weight: 800; }
.color-abraao { color: var(--color-abraao) !important; }
.color-dalto { color: var(--color-dalto) !important; } 
.color-jonathas { color: var(--color-jonathas) !important; } 
.color-lucas { color: var(--color-lucas) !important; }       
.color-efraim { color: var(--color-efraim) !important; }     
.color-cristhian { color: var(--color-cristhian) !important; }  
.color-ernane { color: var(--color-ernane) !important; }       
.color-william { color: var(--color-william) !important; }     
.color-default { color: var(--text) !important; }

.progress{
  display:flex;
  align-items:center;
  gap:10px;
}

.bar{
  flex:1;
  height:8px;
  background:#e5e7eb;
  border-radius:10px;
  overflow:hidden;
}

.fill{
  height:100%;
  background:linear-gradient(90deg, var(--blue), var(--green));
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius:10px;
}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.4);
  backdrop-filter: blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index: 1000;
  padding: 20px;
}

.modal-content{
  background:#fff;
  padding:32px;
  border-radius:20px;
  width:90%;
  max-width:600px;
  box-shadow:0 30px 60px rgba(0,0,0,0.2);
  transform: scale(0.9);
  animation: modalIn 0.3s forwards;
  max-height: 90vh;
  overflow-y: auto;
}

@keyframes modalIn {
  to { transform: scale(1); }
}

.modal-content h2{
  margin-bottom:20px;
  color: var(--blue);
  font-size: 22px;
  border-bottom: 2px solid var(--border);
  padding-bottom: 12px;
}

.modal-content .project-info {
  background: #f8fafc;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.modal-content .info-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}

.modal-content .info-row:last-child {
  border-bottom: none;
}

.modal-content .info-label {
  font-weight: 600;
  color: var(--muted);
  font-size: 13px;
}

.modal-content .info-value {
  font-weight: 700;
  color: var(--text);
  font-size: 14px;
}

.modal-content .tasks-breakdown {
  margin-top: 20px;
}

.modal-content .tasks-breakdown h3 {
  font-size: 15px;
  margin-bottom: 16px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal-content .task-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: white;
  border-radius: 10px;
  margin-bottom: 8px;
  border: 1px solid var(--border);
  transition: all 0.2s;
}

.modal-content .task-item:hover {
  border-color: var(--blue);
  transform: translateX(4px);
}

.modal-content .task-label {
  font-size: 13px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal-content .task-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  font-size: 11px;
}

.modal-content .task-count {
  font-weight: 800;
  font-size: 18px;
  color: var(--blue);
  min-width: 40px;
  text-align: right;
}

.modal-content .obs-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 2px solid var(--border);
}

.modal-content .obs-section h3 {
  font-size: 14px;
  margin-bottom: 10px;
  color: var(--muted);
  text-transform: uppercase;
  font-weight: 700;
}

.modal-content .obs-section p {
  line-height: 1.7;
  color: var(--text);
  white-space: pre-wrap;
  font-size: 14px;
}

.btn-modal{
  border:none;
  background:var(--blue);
  color:#fff;
  padding:14px;
  border-radius:12px;
  width:100%;
  font-weight:700;
  margin-top:24px;
  cursor:pointer;
  transition: all 0.2s;
  font-size: 14px;
}

.btn-modal:hover { 
  filter: brightness(1.1);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}

/* FLOATING BUTTONS */
.floating-buttons {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 999;
}

.float-btn {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  position: relative;
}

.float-btn:hover {
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
}

.float-btn:active {
  transform: scale(0.95);
}

.debug-btn {
  background: var(--text);
  color: white;
}

.debug-btn:hover {
  background: var(--blue);
}

.scroll-top-btn {
  background: var(--green);
  color: white;
  display: none;
}

.scroll-top-btn.show {
  display: flex;
  animation: fadeInUp 0.3s ease;
}

.scroll-top-btn:hover {
  background: var(--blue);
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.float-btn::before {
  content: attr(data-tooltip);
  position: absolute;
  right: 70px;
  background: var(--text);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.float-btn::after {
  content: '';
  position: absolute;
  right: 60px;
  border: 6px solid transparent;
  border-left-color: var(--text);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.float-btn:hover::before,
.float-btn:hover::after {
  opacity: 1;
}

.debug-panel {
  position: fixed;
  bottom: 170px;
  right: 20px;
  width: 500px;
  max-width: calc(100vw - 40px);
  max-height: 400px;
  background: #1e293b;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  display: none;
  flex-direction: column;
  z-index: 998;
  font-family: 'Courier New', monospace;
  font-size: 11px;
  overflow-y: auto;
}

.debug-line {
  padding: 4px 0;
  color: #94a3b8;
  border-bottom: 1px solid #334155;
}

.debug-error { color: #ef4444; font-weight: 600; }
.debug-success { color: #10b981; }
.debug-warning { color: #f59e0b; }

#loading {
  position: fixed;
  top: 10px;
  right: 10px;
  background: var(--blue);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: none;
  z-index: 1100;
  box-shadow: var(--shadow);
}

.no-results {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.no-results i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.no-results h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: var(--text);
}

@media (max-width: 768px) {
  body { padding: 12px; }
  header { flex-direction: column; align-items: flex-start; }
  .kpis { grid-template-columns: 1fr; }
  .charts { grid-template-columns: 1fr; }
  .table-box { padding: 16px; }
  .debug-panel { width: calc(100vw - 40px); bottom: 150px; right: 12px; }
  .floating-buttons { bottom: 12px; right: 12px; }
  .float-btn { width: 50px; height: 50px; font-size: 18px; }
  .modal-content { padding: 24px; }
}
</style>
</head>

<body>
<div id="loading">üîÑ Sincronizando dados...</div>

<div class="container">

<header>
  <h1>OKVENDAS <span>PMO</span></h1>
  <div class="header-actions">
    <button class="btn-clear-filters" id="btnClearFilters" onclick="clearAllFilters()">
      <i class="fa-solid fa-filter-circle-xmark"></i> Limpar Filtros
    </button>
    <button class="btn-refresh" onclick="fetchData()">
      <i class="fa-solid fa-arrows-rotate" id="refresh-icon"></i> Atualizar Dados
    </button>
    <div style="font-size:13px;color:var(--muted)">
      <i class="fa-solid fa-circle" style="color:var(--green);font-size:8px"></i>
      Auto-sincroniza√ß√£o ativa
    </div>
  </div>
</header>

<div class="active-filters" id="activeFilters">
  <span class="filter-label"><i class="fa-solid fa-filter"></i> Filtros ativos:</span>
  <div id="filterTags"></div>
</div>

<div class="kpis">
  <div class="kpi active" onclick="filterByStatus('all')">
    <i class="fa-solid fa-folder-tree"></i>
    <h3>Total Projetos</h3>
    <p id="kTotal">0</p>
    <div class="kpi-hint">Clique para ver todos</div>
  </div>
  <div class="kpi" onclick="filterByStatus('andamento')">
    <i class="fa-solid fa-rocket"></i>
    <h3>Em Andamento</h3>
    <p id="kAtivos">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
  <div class="kpi" onclick="filterByStatus('paralisado')">
    <i class="fa-solid fa-pause"></i>
    <h3>Pausados</h3>
    <p id="kPausados">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
  <div class="kpi" onclick="filterByStatus('cliente')">
    <i class="fa-solid fa-clock-rotate-left"></i>
    <h3>Ag. Cliente</h3>
    <p id="kCliente">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
</div>

<div class="charts">
  <!-- 1. CURVA S -->
  <div class="chart-box">
    <div class="chart-header">
      <div class="chart-title">Acompanhamento Curva S</div>
      <select class="chart-select" id="projectSelect" onchange="updateCurvaS()">
        <option value="all">Vis√£o Geral</option>
      </select>
    </div>
    <div class="chart-container"><canvas id="curve"></canvas></div>
    <div class="chart-info" id="curvaInfo"></div>
  </div>
  
  <!-- 2. CARGA POR ANALISTA -->
  <div class="chart-box">
    <div class="chart-header">
      <div class="chart-title">Carga por Analista</div>
      <select class="chart-select" id="analistaSelect" onchange="updateAnalistaChart()">
        <option value="all">Todos os Analistas</option>
      </select>
    </div>
    <div class="chart-container"><canvas id="analistas"></canvas></div>
  </div>
  
  <!-- 3. DISTRIBUI√á√ÉO DE STATUS -->
  <div class="chart-box">
    <div class="chart-header">
      <div class="chart-title">Distribui√ß√£o de Status</div>
    </div>
    <div class="chart-container"><canvas id="status"></canvas></div>
  </div>
</div>

<div class="table-box">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h2 class="table-title" style="margin-bottom: 0;">Detalhamento de Projetos</h2>
  <div style="display: flex; align-items: center; gap: 10px;">
    <i class="fa-solid fa-search" style="color: var(--muted);"></i>
    <input 
      type="text" 
      id="projectFilter" 
      placeholder="Buscar projeto..." 
      style="padding: 8px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 13px; font-weight: 500; width: 250px; transition: all 0.2s;"
      onkeyup="filterTableByProject()"
      onfocus="this.style.borderColor='var(--blue)'; this.style.boxShadow='0 0 0 3px rgba(14, 165, 233, 0.1)'"
      onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none'"
    />
  </div>
</div>
<table>
<thead>
<tr>
  <th>Projeto</th>
  <th>Data Prevista</th>
  <th>Analista</th>
  <th>Status</th>
  <th style="position: relative;">
    Evolu√ß√£o 
    <i class="fa-solid fa-circle-info" 
       style="font-size: 10px; margin-left: 4px; cursor: help; color: var(--blue);"
       title="C√°lculo Ponderado:
‚Ä¢ Conclu√≠das: 100%
‚Ä¢ Em Valida√ß√£o: 85%
‚Ä¢ Ag. Libera√ß√£o: 60%
‚Ä¢ Em Execu√ß√£o: 40%
‚Ä¢ Ag. In√≠cio: 15%
‚Ä¢ Ag. Descri√ß√£o: 5%"></i>
  </th>
  <th>Info</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<div id="modal">
  <div class="modal-content">
    <h2 id="mTitle"></h2>
    <div class="project-info">
      <div class="info-row">
        <span class="info-label">Analista Respons√°vel:</span>
        <span class="info-value" id="mAnalista"></span>
      </div>
      <div class="info-row">
        <span class="info-label">Status Atual:</span>
        <span class="info-value" id="mStatus"></span>
      </div>
      <div class="info-row">
        <span class="info-label">Data Prevista:</span>
        <span class="info-value" id="mData"></span>
      </div>
      <div class="info-row" style="border-bottom: none; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 12px; border-radius: 8px; margin-top: 8px;">
        <span class="info-label" style="color: var(--blue); font-weight: 700;">
          <i class="fa-solid fa-chart-line"></i> Evolu√ß√£o Ponderada:
        </span>
        <span class="info-value" style="color: var(--blue); font-weight: 800; font-size: 18px;" id="mEvolucao">0%</span>
      </div>
    </div>
    
    <div class="obs-section">
      <h3><i class="fa-solid fa-note-sticky"></i> Observa√ß√µes</h3>
      <p id="mObs"></p>
    </div>
    
    <div class="tasks-breakdown">
      <h3><i class="fa-solid fa-list-check"></i> Detalhamento de Tarefas</h3>
      
      <div class="task-item">
        <div class="task-label">
          <div class="task-icon" style="background: #dcfce7; color: #166534;">
            <i class="fa-solid fa-check"></i>
          </div>
          Conclu√≠das
        </div>
        <div class="task-count" id="mConcluidas">0</div>
      </div>
      
      <div class="task-item">
        <div class="task-label">
          <div class="task-icon" style="background: #dbeafe; color: #1e40af;">
            <i class="fa-solid fa-magnifying-glass"></i>
          </div>
          Em Valida√ß√£o
        </div>
        <div class="task-count" id="mValidacao">0</div>
      </div>
      
      <div class="task-item">
        <div class="task-label">
          <div class="task-icon" style="background: #fef3c7; color: #a16207;">
            <i class="fa-solid fa-unlock"></i>
          </div>
          Ag. Libera√ß√£o
        </div>
        <div class="task-count" id="mLiberacao">0</div>
      </div>
      
      <div class="task-item">
        <div class="task-label">
          <div class="task-icon" style="background: #e0e7ff; color: #4338ca;">
            <i class="fa-solid fa-gears"></i>
          </div>
          Em Execu√ß√£o
        </div>
        <div class="task-count" id="mExecucao">0</div>
      </div>
      
      <div class="task-item">
        <div class="task-label">
          <div class="task-icon" style="background: #f3e8ff; color: #7e22ce;">
            <i class="fa-solid fa-hourglass-start"></i>
          </div>
          Ag. In√≠cio
        </div>
        <div class="task-count" id="mInicio">0</div>
      </div>
      
      <div class="task-item">
        <div class="task-label">
          <div class="task-icon" style="background: #fee2e2; color: #991b1b;">
            <i class="fa-solid fa-file-lines"></i>
          </div>
          Ag. Descri√ß√£o
        </div>
        <div class="task-count" id="mDescricao">0</div>
      </div>
      
      <div class="task-item" style="background: #f0f9ff; border: 2px solid var(--blue);">
        <div class="task-label" style="font-weight: 700; color: var(--blue);">
          <div class="task-icon" style="background: var(--blue); color: white;">
            <i class="fa-solid fa-list"></i>
          </div>
          Total de Tarefas
        </div>
        <div class="task-count" id="mTotal" style="font-size: 22px;">0</div>
      </div>
    </div>
    
    <button class="btn-modal" onclick="closeModal()">Fechar Detalhes</button>
  </div>
</div>

<!-- BOT√ïES FLUTUANTES -->
<div class="floating-buttons">
  <button class="float-btn scroll-top-btn" id="scrollTopBtn" onclick="scrollToTop()" data-tooltip="Voltar ao Topo">
    <i class="fa-solid fa-arrow-up"></i>
  </button>
  <button class="float-btn debug-btn" id="debugBtn" onclick="toggleDebug()" data-tooltip="Console de Debug">
    <i class="fa-solid fa-bug"></i>
  </button>
</div>

<div class="debug-panel" id="debugPanel"></div>

<script>
// ========== CONFIGURA√á√ÉO ==========
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSN6220bHIwZ9pzMZkhQ1hBT32sofXNn-FSvJYDNGFVKNCtEhpTqF3yg4zz-p25nALcm1J33QeLR_pn/pub?gid=378165818&single=true&output=csv';

let projectData = [];
let charts = {};
let currentFilters = { analista: null, status: null };

// ========== SCROLL TO TOP ==========
window.addEventListener('scroll', () => {
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  if (window.pageYOffset > 300) {
    scrollTopBtn.classList.add('show');
  } else {
    scrollTopBtn.classList.remove('show');
  }
});

function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
}

// ========== DEBUG ==========
const debugLogs = [];
const MAX_DEBUG_LOGS = 50;

function debugLog(message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString('pt-BR');
  debugLogs.push({ timestamp, message, type });
  if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
  
  const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
  console.log(`${emoji} [${timestamp}] ${message}`);
  updateDebugPanel();
}

function toggleDebug() {
  const panel = document.getElementById('debugPanel');
  panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  if (panel.style.display === 'block') updateDebugPanel();
}

function updateDebugPanel() {
  const panel = document.getElementById('debugPanel');
  if (panel.style.display === 'block') {
    panel.innerHTML = debugLogs.map(log => {
      const className = log.type === 'error' ? 'debug-error' : 
                        log.type === 'success' ? 'debug-success' : 
                        log.type === 'warning' ? 'debug-warning' : '';
      return `<div class="debug-line ${className}">[${log.timestamp}] ${log.message}</div>`;
    }).reverse().join('');
    panel.scrollTop = 0;
  }
}

// ========== FUN√á√ïES AUXILIARES ==========
function cleanKey(str) {
  if (!str) return "";
  // Remove acentos, espa√ßos extras, pontos e converte para min√∫sculas
  return str.toString()
    .toLowerCase()
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")  // Remove acentos
    .replace(/\./g, "")                 // Remove pontos
    .replace(/\s+/g, " ");              // Normaliza espa√ßos
}

function getAnalistaClass(nome) {
  if (!nome) return 'color-default';
  const n = cleanKey(nome);
  if (n.includes('abraao')) return 'color-abraao';
  if (n.includes('dalto')) return 'color-dalto';
  if (n.includes('jonathas')) return 'color-jonathas';
  if (n.includes('lucas')) return 'color-lucas';
  if (n.includes('efraim')) return 'color-efraim';
  if (n.includes('cristhian')) return 'color-cristhian';
  if (n.includes('ernane')) return 'color-ernane';
  if (n.includes('william')) return 'color-william';
  return 'color-default';
}

function getAnalistaColor(nome) {
  if (!nome) return '#94a3b8';
  const n = cleanKey(nome);
  if (n.includes('abraao')) return '#FFB800';
  if (n.includes('dalto')) return '#f97316';
  if (n.includes('jonathas')) return '#38bdf8';
  if (n.includes('lucas')) return '#0369a1';
  if (n.includes('efraim')) return '#0d9488';
  if (n.includes('cristhian')) return '#475569';
  if (n.includes('ernane')) return '#1e3a8a';
  if (n.includes('william')) return '#16a34a';
  return '#94a3b8';
}

function getStatusColor(status) {
  const s = cleanKey(status);
  if (s.includes('andamento')) return '#10b981';
  if (s.includes('paralisado')) return '#ef4444';
  if (s.includes('cliente')) return '#8b5cf6';
  if (s.includes('planejado')) return '#94a3b8';
  if (s.includes('concluido')) return '#0ea5e9';
  return '#f59e0b';
}

function getSemaforoColor(diferenca) {
  if (Math.abs(diferenca) <= 10) return 'verde';
  if (Math.abs(diferenca) <= 25) return 'amarelo';
  return 'vermelho';
}

// ========== C√ÅLCULO PONDERADO DE EVOLU√á√ÉO ==========
function calcularEvolucaoPonderada(projeto) {
  const { Concluidas, Validacao, Liberacao, Execucao, Inicio, Descricao, Total } = projeto;
  
  if (Total === 0) return 0;
  
  // Pesos para cada est√°gio (quanto cada etapa representa em termos de conclus√£o)
  const pesoConcluidas = 1.00;    // 100% - Tarefa finalizada
  const pesoValidacao = 0.85;     // 85% - Quase pronta, s√≥ falta validar
  const pesoLiberacao = 0.60;     // 60% - Aguardando aprova√ß√£o para seguir
  const pesoExecucao = 0.40;      // 40% - Em desenvolvimento ativo
  const pesoInicio = 0.15;        // 15% - Planejada, pronta para come√ßar
  const pesoDescricao = 0.05;     // 5% - Apenas mapeada, precisa detalhar
  
  // Calcular pontua√ß√£o total baseada nos pesos
  const pontuacaoPonderada = 
    (Concluidas * pesoConcluidas) +
    (Validacao * pesoValidacao) +
    (Liberacao * pesoLiberacao) +
    (Execucao * pesoExecucao) +
    (Inicio * pesoInicio) +
    (Descricao * pesoDescricao);
  
  // Percentual = (pontua√ß√£o alcan√ßada / total poss√≠vel) √ó 100
  const percentual = (pontuacaoPonderada / Total) * 100;
  
  // Log detalhado para projetos com nome espec√≠fico
  if (projeto.Projeto && projeto.Projeto.toLowerCase().includes('temu')) {
    debugLog(`üîç C√ÅLCULO DETALHADO - ${projeto.Projeto}:`, 'info');
    debugLog(`   Conclu√≠das: ${Concluidas} √ó ${pesoConcluidas} = ${Concluidas * pesoConcluidas}`, 'info');
    debugLog(`   Valida√ß√£o: ${Validacao} √ó ${pesoValidacao} = ${Validacao * pesoValidacao}`, 'info');
    debugLog(`   Libera√ß√£o: ${Liberacao} √ó ${pesoLiberacao} = ${Liberacao * pesoLiberacao}`, 'info');
    debugLog(`   Execu√ß√£o: ${Execucao} √ó ${pesoExecucao} = ${Execucao * pesoExecucao}`, 'info');
    debugLog(`   In√≠cio: ${Inicio} √ó ${pesoInicio} = ${Inicio * pesoInicio}`, 'info');
    debugLog(`   Descri√ß√£o: ${Descricao} √ó ${pesoDescricao} = ${Descricao * pesoDescricao}`, 'info');
    debugLog(`   Total: ${Total}`, 'info');
    debugLog(`   Pontua√ß√£o: ${pontuacaoPonderada.toFixed(2)}`, 'info');
    debugLog(`   Percentual: ${percentual.toFixed(2)}%`, 'success');
  }
  
  return Math.min(Math.round(percentual), 100);
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let insideQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];
    
    if (char === '"') {
      if (insideQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        insideQuotes = !insideQuotes;
      }
    } else if (char === ',' && !insideQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  result.push(current.trim());
  return result;
}

// ========== FUN√á√ïES PARA DESTRUIR GR√ÅFICOS COM SEGURAN√áA ==========
function destroyChart(chartKey) {
  if (charts[chartKey]) {
    try {
      charts[chartKey].destroy();
      debugLog(`‚úÖ Gr√°fico ${chartKey} destru√≠do`, 'success');
    } catch (error) {
      debugLog(`‚ö†Ô∏è Erro ao destruir ${chartKey}: ${error.message}`, 'warning');
    }
    charts[chartKey] = null;
  }
}

function destroyAllCharts() {
  Object.keys(charts).forEach(key => destroyChart(key));
  debugLog('üóëÔ∏è Todos os gr√°ficos foram destru√≠dos', 'info');
}

// ========== FETCH DATA ==========
async function fetchData() {
  const loadingEl = document.getElementById('loading');
  const refreshIcon = document.getElementById('refresh-icon');
  
  loadingEl.style.display = 'block';
  if (refreshIcon) refreshIcon.classList.add('spinning');
  
  debugLog('üîÑ Iniciando carregamento...');
  debugLog(`üìä URL: ${SHEET_CSV_URL.substring(0, 80)}...`);
  
  try {
    const url = `${SHEET_CSV_URL}&cachebust=${Date.now()}`;
    debugLog('üåê Fazendo fetch...');
    
    const response = await fetch(url);
    debugLog(`üì° Status: ${response.status}`, response.ok ? 'success' : 'error');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const csvData = await response.text();
    debugLog(`üìù Recebido: ${csvData.length} caracteres`);
    
    const lines = csvData.split(/\r?\n/).filter(l => l.trim());
    debugLog(`üìä Linhas: ${lines.length}`, 'success');
    
    if (lines.length < 2) throw new Error("Planilha vazia");
    
    const headers = parseCSVLine(lines[0]);
    debugLog(`üìã TODOS OS HEADERS DA PLANILHA (${headers.length} colunas):`, 'info');
    headers.forEach((h, i) => {
      debugLog(`   Col ${i}: "${h}" ‚Üí clean: "${cleanKey(h)}"`, 'info');
    });
    
    // Ordem EXATA das colunas na planilha PMO:
    // 0: Projeto
    // 1: Status
    // 2: Data prevista
    // 3: Cor Data Prevista
    // 4: Analista
    // 5: Conclu√≠das
    // 6: Em valida√ß√£o
    // 7: Ag. Libera√ß√£o
    // 8: Em execu√ß√£o
    // 9: Ag. in√≠cio
    // 10: Ag. Descri√ß√£o
    // 11: OBS
    
    const colIdx = {
      projeto: 0,
      status: 1,
      dataPrevista: 2,
      corDataPrevista: 3,
      analista: 4,
      concluidas: 5,
      validacao: 6,
      liberacao: 7,
      execucao: 8,
      inicio: 9,
      descricao: 10,
      obs: 11
    };
    
    debugLog(`üîç Mapeamento de colunas (FIXO):`, 'info');
    debugLog(`   Projeto: col ${colIdx.projeto}`, 'info');
    debugLog(`   Status: col ${colIdx.status}`, 'info');
    debugLog(`   Data Prevista: col ${colIdx.dataPrevista}`, 'info');
    debugLog(`   Cor Data Prevista: col ${colIdx.corDataPrevista}`, 'info');
    debugLog(`   Analista: col ${colIdx.analista}`, 'info');
    debugLog(`   Conclu√≠das: col ${colIdx.concluidas}`, 'info');
    debugLog(`   Valida√ß√£o: col ${colIdx.validacao}`, 'info');
    debugLog(`   Libera√ß√£o: col ${colIdx.liberacao}`, 'info');
    debugLog(`   Execu√ß√£o: col ${colIdx.execucao}`, 'info');
    debugLog(`   In√≠cio: col ${colIdx.inicio}`, 'info');
    debugLog(`   Descri√ß√£o: col ${colIdx.descricao}`, 'info');
    debugLog(`   OBS: col ${colIdx.obs}`, 'info');
    
    projectData = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLine(lines[i]);
      if (colIdx.projeto < 0 || !values[colIdx.projeto]?.trim()) continue;
      
      const getValue = (idx, def = "") => (idx >= 0 && values[idx]) ? values[idx].trim() : def;
      const getNum = (idx) => {
        if (idx < 0) return 0;
        const val = values[idx]?.trim() || "0";
        return parseInt(val.replace(/\D/g, '')) || 0;
      };
      
      const concluidas = getNum(colIdx.concluidas);
      const validacao = getNum(colIdx.validacao);
      const liberacao = getNum(colIdx.liberacao);
      const execucao = getNum(colIdx.execucao);
      const inicio = getNum(colIdx.inicio);
      const descricao = getNum(colIdx.descricao);
      const total = concluidas + validacao + liberacao + execucao + inicio + descricao;
      
      const projeto = {
        Projeto: getValue(colIdx.projeto),
        Status: getValue(colIdx.status, "Planejado"),
        Analista: getValue(colIdx.analista, "N/A"),
        DataPrevista: getValue(colIdx.dataPrevista, "-"),
        CorDataPrevista: getValue(colIdx.corDataPrevista, ""),
        Concluidas: concluidas,
        Validacao: validacao,
        Liberacao: liberacao,
        Execucao: execucao,
        Inicio: inicio,
        Descricao: descricao,
        Total: total,
        Obs: getValue(colIdx.obs, "Sem observa√ß√µes.")
      };
      
      // Log detalhado do primeiro projeto e de "Seguran√ßa de Pagamento"
      if (i === 1 || projeto.Projeto.toLowerCase().includes('seguranca')) {
        debugLog(`üì¶ Projeto: ${projeto.Projeto}`, 'info');
        debugLog(`   Data Prevista: ${projeto.DataPrevista}`, 'info');
        debugLog(`   Cor Data Prevista: "${projeto.CorDataPrevista}"`, 'info');
        debugLog(`   Conclu√≠das: ${concluidas}, Valida√ß√£o: ${validacao}, Libera√ß√£o: ${liberacao}`, 'info');
        debugLog(`   Execu√ß√£o: ${execucao}, In√≠cio: ${inicio}, Descri√ß√£o: ${descricao}`, 'info');
        debugLog(`   Total: ${total}`, 'info');
      }
      
      projectData.push(projeto);
    }
    
    debugLog(`‚úÖ ${projectData.length} projetos carregados!`, 'success');
    
    populateSelects();
    renderAll();
    
    debugLog('üéâ Dashboard renderizado!', 'success');
    
  } catch (error) {
    debugLog(`‚ùå ERRO: ${error.message}`, 'error');
    
    let msg = `Erro ao carregar dados:\n\n${error.message}\n\n`;
    
    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      msg += 'üîí SOLU√á√ïES:\n\n';
      msg += '1. Verifique se a planilha est√° publicada\n';
      msg += '2. V√° em Arquivo > Compartilhar > Publicar na web\n';
      msg += '3. Selecione a aba correta e formato CSV\n';
      msg += '4. Clique em "Publicar"\n';
      msg += '5. Use a URL gerada\n';
    }
    
    alert(msg);
  } finally {
    loadingEl.style.display = 'none';
    if (refreshIcon) refreshIcon.classList.remove('spinning');
  }
}

function populateSelects() {
  // Populate project select (Curva S)
  const projectSelect = document.getElementById('projectSelect');
  projectSelect.innerHTML = '<option value="all">Vis√£o Geral</option>';
  
  // Populate analista select
  const analistaSelect = document.getElementById('analistaSelect');
  analistaSelect.innerHTML = '<option value="all">Todos os Analistas</option>';
  
  const analistas = [...new Set(projectData.map(p => p.Analista))].sort();
  
  projectData.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.Projeto;
    opt.textContent = p.Projeto;
    projectSelect.appendChild(opt);
  });
  
  analistas.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a;
    opt.textContent = a;
    analistaSelect.appendChild(opt);
  });
}

// ========== FILTROS ==========
function filterByAnalista(analista) {
  currentFilters.analista = currentFilters.analista === analista ? null : analista;
  updateFilters();
}

function filterByStatus(status) {
  if (status === 'all') {
    currentFilters.status = null;
  } else {
    currentFilters.status = currentFilters.status === status ? null : status;
  }
  updateFilters();
}

function clearAllFilters() {
  currentFilters = { analista: null, status: null };
  document.getElementById('projectSelect').value = 'all';
  document.getElementById('analistaSelect').value = 'all';
  document.getElementById('projectFilter').value = '';
  updateFilters();
  scrollToTop();
}

function updateFilters() {
  renderAll();
  updateFilterDisplay();
  if (currentFilters.analista || currentFilters.status) {
    setTimeout(() => {
      document.querySelector('.table-box')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
  }
}

function updateFilterDisplay() {
  const activeFiltersEl = document.getElementById('activeFilters');
  const filterTagsEl = document.getElementById('filterTags');
  const btnClear = document.getElementById('btnClearFilters');
  
  const hasFilters = currentFilters.analista || currentFilters.status;
  
  if (hasFilters) {
    activeFiltersEl.style.display = 'flex';
    btnClear.style.display = 'flex';
    
    let tags = '';
    if (currentFilters.analista) tags += `<span class="filter-tag">Analista: ${currentFilters.analista}</span>`;
    if (currentFilters.status) {
      const labels = { andamento: 'Em Andamento', paralisado: 'Paralisado', cliente: 'Ag. Cliente' };
      tags += `<span class="filter-tag">Status: ${labels[currentFilters.status] || currentFilters.status}</span>`;
    }
    filterTagsEl.innerHTML = tags;
  } else {
    activeFiltersEl.style.display = 'none';
    btnClear.style.display = 'none';
  }
  
  document.querySelectorAll('.kpi').forEach(kpi => kpi.classList.remove('active'));
  const kpis = document.querySelectorAll('.kpi');
  if (currentFilters.status === 'andamento') kpis[1]?.classList.add('active');
  else if (currentFilters.status === 'paralisado') kpis[2]?.classList.add('active');
  else if (currentFilters.status === 'cliente') kpis[3]?.classList.add('active');
  else if (!currentFilters.status) kpis[0]?.classList.add('active');
}

function getFilteredData() {
  let filtered = [...projectData];
  if (currentFilters.analista) filtered = filtered.filter(p => p.Analista === currentFilters.analista);
  if (currentFilters.status) filtered = filtered.filter(p => cleanKey(p.Status).includes(currentFilters.status));
  return filtered;
}

// ========== FILTRO DE TABELA POR PROJETO ==========
function filterTableByProject() {
  const input = document.getElementById('projectFilter');
  const filter = cleanKey(input.value);
  const tbody = document.getElementById('tbody');
  const rows = tbody.getElementsByTagName('tr');
  
  let visibleCount = 0;
  
  for (let i = 0; i < rows.length; i++) {
    const projectCell = rows[i].getElementsByTagName('td')[0];
    if (projectCell) {
      const projectName = cleanKey(projectCell.textContent || projectCell.innerText);
      if (projectName.includes(filter)) {
        rows[i].style.display = '';
        visibleCount++;
      } else {
        rows[i].style.display = 'none';
      }
    }
  }
  
  // Se n√£o houver resultados, mostrar mensagem
  if (visibleCount === 0 && filter !== '') {
    tbody.innerHTML = `<tr><td colspan="6"><div class="no-results"><i class="fa-solid fa-search"></i><h3>Nenhum projeto encontrado</h3><p style="margin-top:8px;font-size:13px">Tente outro termo de busca</p></div></td></tr>`;
  }
}

// ========== RENDER ==========
function renderAll() {
  const filtered = getFilteredData();
  renderTable(filtered);
  renderKPIs(projectData);
  renderCharts(filtered);
}

function renderTable(p) {
  const tb = document.getElementById("tbody");
  if (p.length === 0) {
    tb.innerHTML = `<tr><td colspan="6"><div class="no-results"><i class="fa-solid fa-inbox"></i><h3>Nenhum projeto encontrado</h3><p style="margin-top:8px;font-size:13px">Ajuste os filtros</p></div></td></tr>`;
    return;
  }
  
  tb.innerHTML = p.map(x => {
    const perc = calcularEvolucaoPonderada(x);
    const statusClass = cleanKey(x.Status).replace(/\./g, "").replace(/\s/g, '-');
    const analistaClass = getAnalistaClass(x.Analista);
    
    // Escapar aspas para o onclick
    const projetoEscaped = x.Projeto.replace(/'/g, "\\'").replace(/`/g, "\\`");
    
    // Aplicar cor da planilha na data prevista
    const dataStyle = x.CorDataPrevista 
      ? `style="color: ${x.CorDataPrevista}; font-weight: 700;"` 
      : '';
    
    return `<tr>
      <td><span class="project-name" onclick="openProjectModal('${projetoEscaped}')">${x.Projeto}</span></td>
      <td><span ${dataStyle}>${x.DataPrevista}</span></td>
      <td class="analista-bold ${analistaClass}">${x.Analista}</td>
      <td><span class="badge ${statusClass}">${x.Status}</span></td>
      <td><div class="progress"><div class="bar"><div class="fill" style="width:${perc}%"></div></div><strong style="width:35px;text-align:right">${perc}%</strong></div></td>
      <td><i class="fa-solid fa-circle-info" style="cursor:pointer;color:var(--blue)" onclick="openProjectModal('${projetoEscaped}')"></i></td>
    </tr>`;
  }).join("");
}

function renderKPIs(p) {
  document.getElementById("kTotal").innerText = p.length;
  document.getElementById("kAtivos").innerText = p.filter(x => cleanKey(x.Status).includes("andamento")).length;
  document.getElementById("kPausados").innerText = p.filter(x => cleanKey(x.Status).includes("paralisado")).length;
  document.getElementById("kCliente").innerText = p.filter(x => cleanKey(x.Status).includes("cliente")).length;
}

function renderCharts(p) {
  if (p.length === 0) {
    destroyAllCharts();
    return;
  }
  
  // Renderizar Status Chart
  renderStatusChart(p);
  
  // Renderizar outros gr√°ficos
  updateAnalistaChart();
  updateCurvaS();
}

function renderStatusChart(p) {
  const statusCount = {};
  p.forEach(x => {
    if (x.Status) {
      statusCount[x.Status] = (statusCount[x.Status] || 0) + 1;
    }
  });
  
  // Destruir o gr√°fico de status antes de recri√°-lo
  destroyChart('status');
  
  // Status Chart
  const statusLabels = Object.keys(statusCount);
  const statusColors = statusLabels.map(s => getStatusColor(s));
  
  // Validar se h√° dados para renderizar
  if (statusLabels.length === 0) {
    debugLog('‚ö†Ô∏è Nenhum status encontrado para renderizar', 'warning');
    return;
  }
  
  const statusCanvas = document.getElementById('status');
  if (!statusCanvas) {
    debugLog('‚ö†Ô∏è Canvas de status n√£o encontrado', 'warning');
    return;
  }
  
  try {
    charts.status = new Chart(statusCanvas, {
      type: 'doughnut',
      data: {
        labels: statusLabels,
        datasets: [{ 
          data: Object.values(statusCount), 
          backgroundColor: statusColors, 
          borderWidth: 0, 
          hoverOffset: 10 
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { 
            position: 'bottom', 
            labels: { 
              padding: 15, 
              usePointStyle: true, 
              font: { size: 11, weight: '600' } 
            } 
          },
          tooltip: { 
            callbacks: { 
              label: (ctx) => `${ctx.label}: ${ctx.parsed} projeto(s)` 
            } 
          }
        }
      }
    });
    
    debugLog(`‚úÖ Gr√°fico de status criado com ${statusLabels.length} categorias`, 'success');
  } catch (error) {
    debugLog(`‚ùå Erro ao criar gr√°fico de status: ${error.message}`, 'error');
  }
}

function updateAnalistaChart() {
  const select = document.getElementById('analistaSelect');
  const selectedAnalista = select.value;
  
  // Se selecionou um analista espec√≠fico E o filtro atual √© diferente
  if (selectedAnalista !== 'all' && currentFilters.analista !== selectedAnalista) {
    currentFilters.analista = selectedAnalista;
    renderAll(); // Isso vai chamar updateAnalistaChart novamente, mas com o filtro j√° aplicado
    return;
  }
  
  // Se voltou para "Todos" E havia um filtro de analista
  if (selectedAnalista === 'all' && currentFilters.analista) {
    currentFilters.analista = null;
    renderAll();
    return;
  }
  
  // Renderizar o gr√°fico normalmente
  let dataToShow = getFilteredData();
  
  const analistasCount = {};
  dataToShow.forEach(x => {
    analistasCount[x.Analista] = (analistasCount[x.Analista] || 0) + 1;
  });
  
  const analistaLabels = Object.keys(analistasCount);
  const analistaColors = analistaLabels.map(n => getAnalistaColor(n));
  
  // Destruir o gr√°fico de analistas antes de recri√°-lo
  destroyChart('analistas');
  
  const analistasCanvas = document.getElementById('analistas');
  if (!analistasCanvas) {
    debugLog('‚ö†Ô∏è Canvas de analistas n√£o encontrado', 'warning');
    return;
  }
  
  // Validar se h√° dados
  if (analistaLabels.length === 0) {
    debugLog('‚ö†Ô∏è Nenhum analista encontrado para renderizar', 'warning');
    return;
  }
  
  try {
    charts.analistas = new Chart(analistasCanvas, {
      type: 'bar',
      data: {
        labels: analistaLabels,
        datasets: [{ data: Object.values(analistasCount), backgroundColor: analistaColors, borderRadius: 6, barThickness: 20 }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.x} projeto(s)` } }
        },
        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
      }
    });
    
    debugLog(`‚úÖ Gr√°fico de analistas criado com ${analistaLabels.length} analistas`, 'success');
  } catch (error) {
    debugLog(`‚ùå Erro ao criar gr√°fico de analistas: ${error.message}`, 'error');
  }
}

function updateCurvaS() {
  const select = document.getElementById('projectSelect');
  const selectedProject = select.value;
  const curvaInfoEl = document.getElementById('curvaInfo');
  
  let data, label, cor, diferenca;
  
  if (selectedProject === 'all') {
    const filtered = getFilteredData();
    const media = filtered.length > 0 
      ? Math.round(filtered.reduce((acc, curr) => acc + calcularEvolucaoPonderada(curr), 0) / filtered.length)
      : 0;
    
    diferenca = 100 - media;
    const semaforo = getSemaforoColor(diferenca);
    cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
    
    data = [0, media];
    label = 'Realizado (M√©dia Geral)';
    
    curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado`;
    curvaInfoEl.classList.add('show');
  } else {
    const projeto = projectData.find(p => p.Projeto === selectedProject);
    if (projeto) {
      const perc = calcularEvolucaoPonderada(projeto);
      diferenca = 100 - perc;
      const semaforo = getSemaforoColor(diferenca);
      cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
      
      data = [0, perc];
      label = `Realizado (${projeto.Projeto})`;
      
      curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado | <strong>${projeto.Concluidas}/${projeto.Total}</strong> atividades`;
      curvaInfoEl.classList.add('show');
    } else {
      debugLog('‚ö†Ô∏è Projeto n√£o encontrado para Curva S', 'warning');
      return;
    }
  }
  
  // Destruir o gr√°fico de curva S antes de recri√°-lo
  destroyChart('curve');
  
  const curveCanvas = document.getElementById('curve');
  if (!curveCanvas) {
    debugLog('‚ö†Ô∏è Canvas de curva S n√£o encontrado', 'warning');
    return;
  }
  
  try {
    charts.curve = new Chart(curveCanvas, {
      type: 'line',
      data: {
        labels: ['In√≠cio', 'Progresso Atual'],
        datasets: [
          { label: 'Meta Planejada', data: [0, 100], borderColor: '#94a3b8', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0.4, pointRadius: 4 },
          { label: label, data: data, borderColor: cor, backgroundColor: cor + '20', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 7 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11, weight: '600' } } },
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}%` } }
        },
        scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (v) => v + '%' } } }
      }
    });
    
    debugLog(`‚úÖ Curva S criada para: ${selectedProject === 'all' ? 'Vis√£o Geral' : selectedProject}`, 'success');
  } catch (error) {
    debugLog(`‚ùå Erro ao criar Curva S: ${error.message}`, 'error');
  }
}

// ========== MODAL ==========
function openProjectModal(projectName) {
  const projeto = projectData.find(p => p.Projeto === projectName);
  
  if (!projeto) return;
  
  document.getElementById("mTitle").textContent = projeto.Projeto;
  document.getElementById("mAnalista").textContent = projeto.Analista;
  document.getElementById("mStatus").textContent = projeto.Status;
  document.getElementById("mData").textContent = projeto.DataPrevista;
  
  // Calcular e exibir evolu√ß√£o ponderada
  const evolucaoPonderada = calcularEvolucaoPonderada(projeto);
  document.getElementById("mEvolucao").textContent = `${evolucaoPonderada}%`;
  
  document.getElementById("mConcluidas").textContent = projeto.Concluidas;
  document.getElementById("mValidacao").textContent = projeto.Validacao;
  document.getElementById("mLiberacao").textContent = projeto.Liberacao;
  document.getElementById("mExecucao").textContent = projeto.Execucao;
  document.getElementById("mInicio").textContent = projeto.Inicio;
  document.getElementById("mDescricao").textContent = projeto.Descricao;
  document.getElementById("mTotal").textContent = projeto.Total;
  document.getElementById("mObs").textContent = projeto.Obs;
  
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

window.onclick = e => {
  if (e.target == document.getElementById("modal")) closeModal();
}

// ========== INIT ==========
window.onload = fetchData;
setInterval(fetchData, 300000);
window.addEventListener('beforeunload', () => {
  destroyAllCharts();
  clearAllFilters();
});
</script>
</body>
</html>
